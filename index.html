<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>V√≤ng Quay May M·∫Øn</title>
    <style>
      :root {
        --primary-color: #ffde00;
        --text-color: #333;
      }
      body {
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-image: url("web.png");
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        display: flex;
        width: 90%;
        max-width: 1200px;
        /* background: rgba(255, 255, 255, 0.1); */
        /* backdrop-filter: blur(5px); */
        border-radius: 20px;
        /* box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); */
        overflow: hidden;
        flex-wrap: wrap;
      }

      /* Ph·∫ßn b√™n tr√°i: Th·ªÉ l·ªá */
      .left-panel {
        flex: 1;
        min-width: 300px;
        /* background: #fff; */
        padding: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .rules-box h2 {
        color: #d32f2f;
        text-transform: uppercase;
        text-align: center;
        margin-bottom: 20px;
      }

      .rules-list {
        line-height: 1.6;
        color: #555;
      }

      .highlight {
        color: #d32f2f;
        font-weight: bold;
      }

      /* Ph·∫ßn b√™n ph·∫£i: V√≤ng quay */
      .right-panel {
        flex: 1.5;
        min-width: 350px;
        padding: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .wheel-wrapper {
        position: relative;
        width: 100%;
        max-width: 500px; /* ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc v√≤ng quay */
        aspect-ratio: 1/1;
        margin-bottom: 20px;
      }

      #wheel {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.4));
      }

      #spin-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%; /* K√≠ch th∆∞·ªõc n√∫t so v·ªõi v√≤ng quay */
        cursor: pointer;
        z-index: 10;
        transition: transform 0.2s;
      }

      #spin-btn:active {
        transform: translate(-50%, -50%) scale(0.95);
      }

      /* Input Code Section */
      .input-section {
        display: flex;
        gap: 10px;
        width: 100%;
        max-width: 400px;
        margin-top: 20px;
      }

      /* Legend under the wheel */
      .legend {
        display: flex;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.8);
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 600;
        color: #222;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      }

      .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        display: inline-block;
      }

      .legend-color.red {
        background: #e53935;
      }
      .legend-color.yellow {
        background: #ffde00;
      }
      .legend-color.green {
        background: #43a047;
      }

      input[type="text"] {
        flex: 1;
        padding: 12px;
        border: 2px solid #fff;
        border-radius: 8px;
        font-size: 16px;
        outline: none;
        text-transform: uppercase;
      }

      button.primary-btn {
        padding: 12px 24px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }

      button.primary-btn:hover {
        background: #b71c1c;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      /* Modal Form */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        text-align: center;
        position: relative;
      }

      .modal h2 {
        color: #d32f2f;
      }

      .prize-display {
        font-size: 24px;
        color: #2e7d32;
        margin: 20px 0;
        font-weight: bold;
      }

      .form-group {
        margin-bottom: 15px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      #loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        z-index: 200;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        font-weight: bold;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .container {
          flex-direction: column-reverse; /* ƒê∆∞a v√≤ng quay l√™n tr√™n rules ·ªü mobile */
        }
        .left-panel {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div id="loading">ƒêang x·ª≠ l√Ω...</div>

    <div class="container">
      <div class="left-panel">
        <div class="rules-box">
          <h2>Th·ªÉ L·ªá V√≤ng Quay</h2>
          <ul class="rules-list">
            <li>M·ªói m√£ code t∆∞∆°ng ·ª©ng v·ªõi 1 l∆∞·ª£t quay.</li>
            <li>M√£ code ch·ªâ s·ª≠ d·ª•ng ƒë∆∞·ª£c 1 l·∫ßn duy nh·∫•t.</li>
            <li>
              C∆° c·∫•u gi·∫£i th∆∞·ªüng:
              <ul>
                <li>
                  <span class="highlight">Gi·∫£i ƒê·∫∑c Bi·ªát: Voucher 1tr8</span>
                </li>
                <li>Gi·∫£i Nh√¨: Voucher 1tr6</li>
                <li>Gi·∫£i Ba: Voucher 1tr4</li>
              </ul>
            </li>
            <li>Vui l√≤ng nh·∫≠p th√¥ng tin ch√≠nh x√°c ƒë·ªÉ nh·∫≠n qu√†.</li>
          </ul>
        </div>
      </div>

      <div class="right-panel">
        <div class="wheel-wrapper">
          <img src="VoÃÄng quay.png" id="wheel" alt="Wheel" />
          <img
            src="NuÃÅt baÃÇÃÅm quay.png"
            id="spin-btn"
            alt="Spin"
            onclick="validateAndSpin()"
          />
        </div>

        <div class="legend" aria-hidden="false">
          <div class="legend-item">
            <span class="legend-color red"></span>H·∫°ng v√© 1800
          </div>
          <div class="legend-item">
            <span class="legend-color green"></span>H·∫°ng v√© 1600
          </div>
          <div class="legend-item">
            <span class="legend-color yellow"></span>H·∫°ng v√© 1400
          </div>
        </div>

        <div class="input-section">
          <input
            type="text"
            id="code-input"
            placeholder="Nh·∫≠p m√£ code c·ªßa b·∫°n..."
          />
          <button
            class="primary-btn"
            id="check-btn"
            onclick="validateAndSpin()"
          >
            QUAY NGAY
          </button>
        </div>
      </div>
    </div>

    <div id="prizeModal" class="modal">
      <div class="modal-content">
        <h2>üéâ CH√öC M·ª™NG üéâ</h2>
        <p>B·∫°n ƒë√£ tr√∫ng gi·∫£i th∆∞·ªüng:</p>
        <div id="prize-name" class="prize-display"></div>
        <p>Vui l√≤ng ƒëi·ªÅn th√¥ng tin ƒë·ªÉ nh·∫≠n th∆∞·ªüng:</p>

        <form id="winner-form" onsubmit="submitWinner(event)">
          <div class="form-group">
            <label>H·ªç v√† T√™n</label>
            <input
              type="text"
              id="fullname"
              required
              placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n"
            />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="email"
              required
              placeholder="Nh·∫≠p email c·ªßa b·∫°n"
            />
          </div>
          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input
              type="tel"
              id="phone"
              pattern="[0-9]{10}"
              required
              title="Vui l√≤ng nh·∫≠p ƒë√∫ng 10 s·ªë ƒëi·ªán tho·∫°i"
              placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n"
            />
          </div>
          <button type="submit" class="primary-btn" style="width: 100%">
            NH·∫¨N TH∆Ø·ªûNG
          </button>
        </form>
      </div>
    </div>

    <script>
      // C·∫§U H√åNH URL API T·ª™ GOOGLE SHEET ·ªû B∆Ø·ªöC 1
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbykH31GJAdwBG5XrqwRHhdZbegvEyPbbtYw8IQMDWhFjGEGcC9F8JyHeT9t4-fwBfnM/exec";

      const wheel = document.getElementById("wheel");
      const codeInput = document.getElementById("code-input");
      const modal = document.getElementById("prizeModal");
      const loading = document.getElementById("loading");

      let currentDeg = 0;
      let isSpinning = false;
      let currentCode = "";
      let currentPrize = "";

      // Logic t·ªâ l·ªá tr√∫ng th∆∞·ªüng
      // 20% = 1tr8, 40% = 1tr6, 40% = 1tr4
      // D·ª±a v√†o ·∫£nh:
      // ƒê·ªè (1 g√≥c l·ªõn): Gi·∫£ s·ª≠ l√† 1tr8
      // Xanh l√°: 1tr6
      // V√†ng: 1tr4
      // C·∫ßn ch·ªânh l·∫°i g√≥c quay cho kh·ªõp v·ªõi h√¨nh ·∫£nh th·ª±c t·∫ø c·ªßa b·∫°n.
      // Gi·∫£ s·ª≠ ·∫£nh: 3 ph·∫ßn b·∫±ng nhau (120 ƒë·ªô m·ªói ph·∫ßn)
      // 0-120: ƒê·ªè (1tr8), 120-240: V√†ng (1tr4), 240-360: Xanh (1tr6)

      const prizes = [
        {
          name: "Voucher 1.800.000ƒë",
          color: "red",
          minDeg: 15,
          maxDeg: 105,
          percent: 20,
        },
        {
          name: "Voucher 1.400.000ƒë",
          color: "yellow",
          minDeg: 135,
          maxDeg: 225,
          percent: 40,
        },
        {
          name: "Voucher 1.600.000ƒë",
          color: "green",
          minDeg: 255,
          maxDeg: 345,
          percent: 40,
        },
      ];

      async function validateAndSpin() {
        if (isSpinning) return;

        const code = codeInput.value.trim().toUpperCase();
        if (!code) {
          alert("Vui l√≤ng nh·∫≠p m√£ code!");
          return;
        }

        loading.style.display = "flex";

        try {
          // G·ªçi API check code
          const response = await fetch(
            `${SCRIPT_URL}?action=check_code&code=${code}`
          );
          const data = await response.json();

          if (data.status === "success") {
            currentCode = code;
            loading.style.display = "none";
            startSpin();
          } else {
            loading.style.display = "none";
            alert(data.message); // Code sai ho·∫∑c ƒë√£ d√πng
          }
        } catch (error) {
          loading.style.display = "none";
          alert("L·ªói k·∫øt n·ªëi! Vui l√≤ng th·ª≠ l·∫°i.");
          console.error(error);
        }
      }

      function startSpin() {
        isSpinning = true;
        document.getElementById("check-btn").disabled = true;
        document.getElementById("code-input").disabled = true;

        // T√≠nh to√°n gi·∫£i th∆∞·ªüng d·ª±a tr√™n t·ªâ l·ªá
        const rand = Math.random() * 100;
        let selectedPrize;
        let cumulative = 0;

        for (let p of prizes) {
          cumulative += p.percent;
          if (rand < cumulative) {
            selectedPrize = p;
            break;
          }
        }

        // T√≠nh g√≥c quay ƒë·ªÉ kim ch·ªâ v√†o v√πng gi·∫£i th∆∞·ªüng
        // Random m·ªôt g√≥c trong kho·∫£ng cho ph√©p c·ªßa gi·∫£i ƒë√≥
        const stopAngle =
          Math.floor(
            Math.random() * (selectedPrize.maxDeg - selectedPrize.minDeg + 1)
          ) + selectedPrize.minDeg;

        // Quay √≠t nh·∫•t 5 v√≤ng (1800 ƒë·ªô) + g√≥c d·ª´ng
        // L∆∞u √Ω: CSS rotate quay theo chi·ªÅu kim ƒë·ªìng h·ªì.
        // N·∫øu kim ch·ªâ ·ªü 12h, th√¨ g√≥c d·ª´ng th·ª±c t·∫ø tr√™n ·∫£nh ph·∫£i tr·ª´ ƒëi.
        // ƒê·ªÉ ƒë∆°n gi·∫£n, ta xoay ·∫£nh. Mu·ªën kim (c·ªë ƒë·ªãnh) ch·ªâ v√†o ƒê·ªè, th√¨ ƒê·ªè ph·∫£i n·∫±m ·ªü v·ªã tr√≠ kim.

        // Gi·∫£ s·ª≠ kim ·ªü h∆∞·ªõng 12h (tr√™n c√πng).
        // Logic quay:
        const totalRotation = 360 * 10 + (360 - stopAngle);

        currentDeg += totalRotation;
        currentPrize = selectedPrize.name;

        wheel.style.transform = `rotate(${currentDeg}deg)`;

        // ƒê·ª£i quay xong (5s theo CSS)
        setTimeout(() => {
          isSpinning = false;
          showWinnerForm();
        }, 5000);
      }

      function showWinnerForm() {
        document.getElementById("prize-name").innerText = currentPrize;
        // Highlight n·∫øu l√† gi·∫£i ƒë·∫∑c bi·ªát
        if (currentPrize.includes("1.800.000")) {
          document.getElementById("prize-name").style.color = "red";
          document.getElementById("prize-name").style.fontSize = "30px";
          alert("CH√öC M·ª™NG! B·∫†N ƒê√É TR√öNG GI·∫¢I ƒê·∫∂C BI·ªÜT!");
        }
        modal.style.display = "flex";
      }

      async function submitWinner(e) {
        e.preventDefault();
        loading.style.display = "flex";

        const name = document.getElementById("fullname").value;
        const email = document.getElementById("email").value;
        const phone = document.getElementById("phone").value;

        // X√¢y d·ª±ng URL ƒë·ªÉ g·ª≠i data (d√πng GET request cho ƒë∆°n gi·∫£n ƒë·ªÉ tr√°nh CORS ph·ª©c t·∫°p v·ªõi GAS free)
        // L∆∞u √Ω: data ƒë∆∞·ª£c g·ª≠i c√¥ng khai tr√™n URL, v·ªõi d·ªØ li·ªáu nh·∫°y c·∫£m th·ª±c t·∫ø n√™n d√πng POST
        // Nh∆∞ng v·ªõi GAS Web App free, GET ·ªïn ƒë·ªãnh h∆°n cho ng∆∞·ªùi m·ªõi.

        const params = new URLSearchParams({
          action: "save_winner",
          code: currentCode,
          name: name,
          email: email,
          phone: phone,
          prize: currentPrize,
        });

        try {
          // S·ª≠ d·ª•ng fetch mode no-cors n·∫øu g·∫∑p l·ªói CORS,
          // nh∆∞ng ·ªü ƒë√¢y ta d√πng redirect form c·ªßa GAS JSON tr·∫£ v·ªÅ n√™n try standard fetch
          await fetch(`${SCRIPT_URL}?${params.toString()}`, {
            method: "POST",
          });

          // V√¨ Apps Script ƒë√¥i khi tr·∫£ v·ªÅ redirect l√†m fetch kh√¥ng ƒë·ªçc ƒë∆∞·ª£c JSON tr·ª±c ti·∫øp n·∫øu kh√¥ng c·∫•u h√¨nh k·ªπ
          // Ta c·ª© m·∫∑c ƒë·ªãnh th√†nh c√¥ng n·∫øu kh√¥ng l·ªói m·∫°ng

          loading.style.display = "none";
          modal.style.display = "none";
          alert("ƒê√£ l∆∞u th√¥ng tin nh·∫≠n th∆∞·ªüng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.");
          location.reload(); // Reset game
        } catch (error) {
          loading.style.display = "none";
          alert("ƒê√£ c√≥ l·ªói x·∫£y ra ho·∫∑c ƒë√£ l∆∞u th√†nh c√¥ng.");
          location.reload();
        }
      }
    </script>
  </body>
</html>
